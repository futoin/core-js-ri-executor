!function(a){"function"==typeof define&&define.amd?define(["futoin-asyncsteps","futoin-invoker","lodash"],a):"object"==typeof exports?module.exports=a(require("futoin-asyncsteps"),require("futoin-invoker"),require("lodash")):this.FutoInExecutor=a($as,FutoInInvoker,_)}(function(a,b,c){function d(a){var b=d.cache[a];if(!b){var c={};b=d.cache[a]={id:a,exports:c},d.modules[a].call(c,b,c)}return b.exports}var e=this;return d.cache=[],d.modules=[function(a){!function(b){"use strict";var c=b.FutoIn||{};if("undefined"==typeof c.Executor){var e=d(2);b.FutoInExecutor=e,c.Executor=e,b.FutoIn=c,a&&(a.exports=e)}}(window)},function(a,b){"use strict";var c=d(6),e=d(5),f=e.FutoInError,g={OPT_VAULT:"vault",OPT_SPEC_DIRS:e.AdvancedCCM.OPT_SPEC_DIRS,OPT_PROD_MODE:e.AdvancedCCM.OPT_PROD_MODE},h=function(a,b){this._ccm=a,this._ifaces={},this._impls={},b=b||{};var c=b[this.OPT_SPEC_DIRS];c instanceof Array||(c=[c]),this._specdirs=c,this._dev_checks=!b[this.OPT_PROD_MODE]};h.prototype={_ccm:null,_ifaces:null,_impls:null,_specdirs:null,_dev_checks:!1,ccm:function(){return this._ccm},register:function(a,b,c){var d=b.match(e.SpecTools._ifacever_pattern);null===d&&a.error(f.InternalError,"Invalid ifacever");var g=d[1],h=d[4],i=d[5],j=d[6],k=this._ifaces;g in k&&i in k[g]&&a.error(f.InternalError,"Already registered");var l={iface:g,version:h,mjrver:i,mnrver:j};e.SpecTools.loadIface(a,l,this._specdirs);var m=this;a.add(function(a){g in k||(k[g]={},m._impls[g]={}),k[g][i]=l,m._impls[g][i]=c;for(var b=0;b<l.inherits.length;++b){var d=l.inherits[b].match(e.SpecTools._ifacever_pattern),h=d[1],j=d[4],n=d[5],o=d[6],p={iface:h,version:j,mjrver:n,mnrver:o,derived:l};h in k&&n in k[h]&&(delete k[g][i],a.error(f.InternalError,"Conflict with inherited interfaces")),h in k||(k[h]={}),k[h][n]=p}})},process:function(a){(!("reqinfo"in a.state)||"_futoin_func_info"in a.state)&&a.error(f.InternalError,"Invalid process() invocation");var b=this;a.add(function(a){var d=a.state.reqinfo;b._getInfo(a,d),a.add(function(a){b._checkConstraints(a,d),b._checkParams(a,d)}),a.add(function(a){var e=a.state._futoin_func,g=b._getImpl(a,d);e in g||a.error(f.InternalError,"Missing function implementation");var h=g[e](a,d);h&&c.extend(d.result(),h)}),a.add(function(a,e){e&&c.extend(d.result(),e),b._checkResult(a,d),b._signResponse(a,d),b._packResponse(a,d)})},function(a,c){var d=a.state.reqinfo,g=a.state.error_info;c in e.SpecTools.standard_errors||a.state._futoin_func_info&&c in a.state._futoin_func_info["throws"]||(b._onNotExpected(a,c,g),c=f.InternalError,g="Not expected error");var h=d.info[d.INFO_RAW_RESPONSE];h.e=c,delete h.r,g&&(h.edesc=g),b._signResponse(a,d),b._packError(a,d),a.success()})},checkAccess:function(a,b){a.error(f.NotImplemented,"Access Control is not supported yet")},initFromCache:function(a){a.error(f.NotImplemented,"Caching is not supported yet")},cacheInit:function(a){a.error(f.NotImplemented,"Caching is not supported yet")},_getInfo:function(a,b){var c=b.info,d=c[b.INFO_RAW_REQUEST].f;"string"!=typeof d&&a.error(f.InvalidRequest,"Missing req.f"),d=d.split(":"),3!==d.length&&a.error(f.InvalidRequest,"Invalid req.f");var e=d[0],g=d[2],h=d[1].split(".");2!==h.length&&a.error(f.InvalidRequest,"Invalid req.f (version)"),e in this._ifaces||a.error(f.UnknownInterface,"Unknown Interface");var i=h[0],j=h[1];i in this._ifaces[e]||a.error(f.NotSupportedVersion,"Different major version");var k=this._ifaces[e][i];k.mnrver<j&&a.error(f.NotSupportedVersion,"Iface version is too old"),"derived"in k&&(k=k.derived),g in k.funcs||a.error(f.InvalidRequest,"Not defined interface function");var l=k.funcs[g];a.state._futoin_iface_info=k,a.state._futoin_func=g,a.state._futoin_func_info=l,l.rawresult&&(c[b.INFO_HAVE_RAW_RESULT]=!0)},_checkConstraints:function(a,b){var c=b.info,d=a.state._futoin_iface_info.constraints;"SecureChannel"in d&&!c[b.INFO_SECURE_CHANNEL]&&a.error(f.SecurityError,"Insecure channel"),"AllowAnonymous"in d||c[b.INFO_USER_INFO]||a.error(f.SecurityError,"Anonymous not allowed"),!("BiDirectChannel"in d)||c[b.INFO_CHANNEL_CONTEXT]&&c[b.INFO_CHANNEL_CONTEXT].isStateful()||a.error(f.InvalidRequest,"Bi-Direct Channel is required")},_checkParams:function(a,b){var c=b.info[b.INFO_RAW_REQUEST],d=a.state._futoin_func_info;if(b[b.INFO_HAVE_RAW_UPLOAD]&&!d.rawupload&&a.error(f.InvalidRequest,"Raw upload is not allowed"),"p"in c){var g,h=c.p;for(g in h)g in d.params||a.error(f.InvalidRequest,"Unknown parameter"),e.SpecTools.checkParameterType(a,a.state._futoin_iface_info,a.state._futoin_func,g,h[g]);for(g in d.params)if(!(g in h)){var i=d.params[g];"default"in i?h[g]=i["default"]:a.error(f.InvalidRequest,"Missing parameter: "+g)}}else Object.keys(d.params).length>0&&a.error(f.InvalidRequest,"Missing parameter (any)")},_getImpl:function(a,b){var c=a.state._futoin_iface_info,d=c.iface,e=c.mjrver,g=this._impls[d][e];return"object"!=typeof g&&("function"==typeof g?g=g(g,this):a.error(f.InternalError,"Invalid implementation type"),"object"!=typeof g&&a.error(f.InternalError,"Implementation does not implement InterfaceImplementation"),this._impls[d][e]=g),g},_checkResult:function(a,b){if(this._dev_checks){var c=b.info[b.INFO_RAW_RESPONSE],d=a.state._futoin_func_info;if(d.rawresult)return void(Object.keys(c.r).length>0&&a.error(f.InternalError,"Raw result is expected"));if(Object.keys(d.result).length>0){var g,h=d.result,i=0;for(g in c.r)g in h||a.error(f.InternalError,"Unknown result variable '"+g+"'"),e.SpecTools.checkResultType(a,a.state._futoin_iface_info,a.state._futoin_func,g,c.r[g]),++i;Object.keys(h).length!==i&&a.error(f.InternalError,"Missing result variables")}else Object.keys(c.r).length>0&&a.error(f.InternalError,"No result variables are expected")}},_signResponse:function(a,b){!b.info[b.INFO_DERIVED_KEY]},_packResponse:function(a,b){var c=b.info,d=a.state._futoin_func_info;return d.rawresult?void(c[b.INFO_RAW_RESPONSE]=null):d.expect_result||c[b.INFO_RAW_REQUEST].forcersp===!0?void(c[b.INFO_RAW_RESPONSE]=JSON.stringify(c[b.INFO_RAW_RESPONSE])):void(c[b.INFO_RAW_RESPONSE]=null)},_packError:function(a,b){var c=b.info;c[b.INFO_RAW_RESPONSE]=JSON.stringify(c[b.INFO_RAW_RESPONSE])},_onNotExpected:function(a,b,c){}},c.extend(h,g),c.extend(h.prototype,g),b.Executor=h,b.ExecutorConst=g},function(a,b){"use strict";var c=d(4),e=d(6);b.Executor=d(1).Executor;var f=d(3);if(e.extend(b,f),c){var g=require;b.NodeExecutor=g("./node_executor")}},function(a,b){"use strict";var c=d(6),e=d(7),f={INFO_FirstName:"FirstName",INFO_FullName:"FullName",INFO_DateOfBirth:"DateOfBirth",INFO_TimeOfBirth:"TimeOfBirth",INFO_ContactEmail:"ContactEmail",INFO_ContactPhone:"ContactPhone",INFO_HomeAddress:"HomeAddress",INFO_WorkAddress:"WorkAddress",INFO_Citizenship:"Citizenship",INFO_GovernmentRegID:"GovernmentRegID",INFO_AvatarURL:"AvatarURL"};b.UserInfo=function(a,b,c){this._ccm=a,this._local_id=b,this._global_id=c},b.UserInfo.prototype={localID:function(){return this._local_id},globalID:function(){return this._global_id},details:function(a,b){a.error("NotImplemented")}},c.extend(b.UserInfo,f),c.extend(b.UserInfo.prototype,f),b.SourceAddress=function(a,b,c){null===a&&(a="string"!=typeof b?"LOCAL":b.match(/^([0-9]{1,3}\.){3}[0-9]{1,3}$/)?"IPv4":"IPv6"),this.type=a,this.host=b,this.port=c},b.SourceAddress.prototype={host:null,port:null,type:null,asString:function(){return"LOCAL"===this.type?"LOCAL:"+this.port:"IPv6"===this.type?"IPv6:["+this.host+"]:"+this.port:this.type+":"+this.host+":"+this.port}},b.DerivedKey=function(a,b,c){this._ccm=a,this._base_id=b,this._sequence_id=c},b.DerivedKey.prototype={baseID:function(){return this._base_id},sequenceID:function(){return this._sequence_id},encrypt:function(a,b){},decrypt:function(a,b){}},b.ChannelContext=function(){this.state=function(){return this.state}},b.ChannelContext.prototype={state:null,type:function(){},isStateful:function(){return!1},onInvokerAbort:function(a,b){},openRawInput:function(){return null},openRawOutput:function(){return null}};var g={SL_ANONYMOUS:"Anonymous",SL_INFO:"Info",SL_SAFEOPS:"SafeOps",SL_PRIVLEGED_OPS:"PrivilegedOps",SL_EXCEPTIONAL_OPS:"ExceptionalOps",INFO_X509_CN:"X509_CN",INFO_PUBKEY:"PUBKEY",INFO_CLIENT_ADDR:"CLIENT_ADDR",INFO_SECURE_CHANNEL:"SECURE_CHANNEL",INFO_REQUEST_TIME_FLOAT:"REQUEST_TIME_FLOAT",INFO_SECURITY_LEVEL:"SECURITY_LEVEL",INFO_USER_INFO:"USER_INFO",INFO_RAW_REQUEST:"RAW_REQUEST",INFO_RAW_RESPONSE:"RAW_RESPONSE",INFO_DERIVED_KEY:"DERIVED_KEY",INFO_HAVE_RAW_UPLOAD:"HAVE_RAW_UPLOAD",INFO_HAVE_RAW_RESULT:"HAVE_RAW_RESULT",INFO_CHANNEL_CONTEXT:"CHANNEL_CONTEXT"};b.RequestInfo=function(a,b){this._executor=a,"string"==typeof b&&(b=JSON.parse(b)),this._rawreq=b;var c={r:{}};"rid"in b&&(c.rid=b.rid),this._rawrsp=c;var d=function(){return this.info};this.info=d,d[this.INFO_X509_CN]=null,d[this.INFO_X509_CN]=null,d[this.INFO_PUBKEY]=null,d[this.INFO_CLIENT_ADDR]=null,d[this.INFO_SECURE_CHANNEL]=!1,d[this.INFO_SECURITY_LEVEL]=this.SL_ANONYMOUS,d[this.INFO_USER_INFO]=null,d[this.INFO_RAW_REQUEST]=b,d[this.INFO_RAW_RESPONSE]=c,d[this.INFO_DERIVED_KEY]=null,d[this.INFO_HAVE_RAW_UPLOAD]=!1,d[this.INFO_HAVE_RAW_RESULT]=!1,d[this.INFO_CHANNEL_CONTEXT]=null,d[this.INFO_REQUEST_TIME_FLOAT]=e()},b.RequestInfo.prototype={_executor:null,_rawreq:null,_rawrsp:null,_rawinp:null,_rawout:null,params:function(){return this._rawreq.p},result:function(){return this._rawrsp.r},rawInput:function(){this.info[this.INFO_HAVE_RAW_UPLOAD]&&null===this._rawinp&&null!==this.info[this.INFO_CHANNEL_CONTEXT]&&(this._rawinp=this.info[this.INFO_CHANNEL_CONTEXT].openRawInput());var a=this._rawinp;if(!a)throw new Error("RawInputError");return a},rawOutput:function(){this.info[this.INFO_HAVE_RAW_RESULT]&&null===this._rawout&&null!==this.info[this.INFO_CHANNEL_CONTEXT]&&(this._rawout=this.info[this.INFO_CHANNEL_CONTEXT].openRawOutput());var a=this._rawout;if(!a)throw new Error("RawOutputError");return a},executor:function(){return this._executor}},c.extend(b.RequestInfo,g),c.extend(b.RequestInfo.prototype,g)},function(a){a.exports=!1;try{a.exports="[object process]"===Object.prototype.toString.call(e.process)}catch(b){}},function(a){a.exports=b},function(a){a.exports=c},function(a){(function(){var b,c,d;"undefined"!=typeof performance&&null!==performance&&performance.now?a.exports=function(){return performance.now()}:"undefined"!=typeof process&&null!==process&&process.hrtime?(a.exports=function(){return(b()-d)/1e6},c=process.hrtime,b=function(){var a;return a=c(),1e9*a[0]+a[1]},d=b()):Date.now?(a.exports=function(){return Date.now()-d},d=Date.now()):(a.exports=function(){return(new Date).getTime()-d},d=(new Date).getTime())}).call(this)}],d(0)});